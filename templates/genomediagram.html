{% extends "base.html" %}

{% block title %}Genome Diagrams - NuGenBioPython{% endblock %}

{% block content %}
<style>
    #genomeDiagramTabs button.nav-link:hover { background: rgba(255,255,255,0.25) !important; }
    #genomeDiagramTabs button.nav-link.active { background: rgba(255,255,255,0.15) !important; }
</style>

<div class="row mb-2">
    <div class="col-12">
        <h2 class="text-primary mb-1">
            <i class="fas fa-chart-area"></i> Genome Diagrams
        </h2>
        <p class="lead mb-2">Create visual representations of genomic features using Bio.Graphics.GenomeDiagram</p>
    </div>
</div>

<div class="card shadow-sm border-0 mb-2">
    <div class="card-header bg-gradient p-0 border-0">
        <div class="d-flex flex-wrap" id="genomeDiagramTabs" role="tablist">
            <button class="flex-fill nav-link active text-white border-0 py-3 px-3 fw-bold"
                    id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button">
                <i class="fas fa-chart-area d-block mb-1"></i>
                <small>Basic Diagram</small>
            </button>
            <button class="flex-fill nav-link text-white border-0 py-3 px-3 fw-bold"
                    id="multitrack-tab" data-bs-toggle="tab" data-bs-target="#multitrack" type="button">
                <i class="fas fa-layer-group d-block mb-1"></i>
                <small>Multi-Track</small>
            </button>
            <button class="flex-fill nav-link text-white border-0 py-3 px-3 fw-bold"
                    id="datatracks-tab" data-bs-toggle="tab" data-bs-target="#datatracks" type="button">
                <i class="fas fa-chart-line d-block mb-1"></i>
                <small>Data Tracks</small>
            </button>
            <button class="flex-fill nav-link text-white border-0 py-3 px-3 fw-bold"
                    id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button">
                <i class="fas fa-magic d-block mb-1"></i>
                <small>Advanced</small>
            </button>
            <button class="flex-fill nav-link text-white border-0 py-3 px-3 fw-bold"
                    id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button">
                <i class="fas fa-download d-block mb-1"></i>
                <small>Export</small>
            </button>
        </div>
    </div>

    <div class="card-body p-3">
        <div class="tab-content">

            <!-- ============================================================ -->
            <!-- BASIC DIAGRAM TAB -->
            <!-- ============================================================ -->
            <div class="tab-pane fade show active" id="basic">
                <div class="row g-3">
                    <div class="col-md-8">
                        <div class="card mb-3">
                            <div class="card-body p-3">
                                <form id="basicDiagramForm">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-6">
                                            <label for="genomeLength" class="form-label small mb-1">Genome Length (bp)</label>
                                            <input type="number" class="form-control form-control-sm" id="genomeLength"
                                                   value="50000" min="1000" max="10000000">
                                        </div>
                                        <div class="col-md-6">
                                            <label for="diagramTitle" class="form-label small mb-1">Diagram Title</label>
                                            <input type="text" class="form-control form-control-sm" id="diagramTitle"
                                                   value="Genome Features" placeholder="Enter title...">
                                        </div>
                                    </div>

                                    <div class="row g-2 mb-3">
                                        <div class="col-md-6">
                                            <label for="diagramType" class="form-label small mb-1">Diagram Type</label>
                                            <select class="form-select form-select-sm" id="diagramType">
                                                <option value="linear">Linear</option>
                                                <option value="circular">Circular</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label for="pageSize" class="form-label small mb-1">Page Size</label>
                                            <select class="form-select form-select-sm" id="pageSize">
                                                <option value="A4">A4 (210 × 297 mm)</option>
                                                <option value="letter" selected>Letter (8.5 × 11 in)</option>
                                                <option value="A3">A3 (297 × 420 mm)</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small mb-1">File Upload (GenBank, EMBL, or FASTA)</label>
                                        <input type="file" class="form-control form-control-sm" id="basicSequenceFile"
                                               accept=".gb,.gbk,.genbank,.embl,.fasta,.fa,.fna"
                                               onchange="handleBasicFileUpload(event)">
                                        <div class="form-text small">
                                            <i class="fas fa-upload text-muted"></i> Upload GenBank/EMBL to auto-extract features
                                        </div>
                                        <div id="basicFileInfo" class="mt-1" style="display:none;"></div>
                                    </div>

                                    <hr class="my-3">

                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label small mb-0"><strong>Genomic Features</strong></label>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    onclick="addFeature()">
                                                <i class="fas fa-plus"></i> Add Feature
                                            </button>
                                        </div>
                                        <div id="featuresContainer">
                                            <!-- Features added dynamically -->
                                        </div>
                                    </div>

                                    <button type="submit" class="gradient-btn-primary w-100 mb-2 mt-2" id="createBasicDiagramBtn">
                                        <i class="fas fa-chart-area"></i> Create Diagram
                                    </button>
                                    <button type="button" class="gradient-btn-secondary w-100 mb-2"
                                            onclick="loadBasicExample()">
                                        <i class="fas fa-flask"></i> Load Example
                                    </button>
                                    <button type="button" class="gradient-btn-small w-100"
                                            onclick="clearFeatures()">
                                        <i class="fas fa-trash"></i> Clear Features
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-body p-3">
                                <p class="small mb-2"><strong><i class="fas fa-info-circle"></i> Feature Summary</strong></p>
                                <div id="featureSummary">
                                    <p class="text-muted text-center small mb-0">
                                        <i class="fas fa-plus fa-2x mb-2"></i><br>
                                        Add features to see summary
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small"><i class="fas fa-image"></i> Generated Diagram</h6>
                            </div>
                            <div class="card-body p-3 text-center" id="basicDiagramDisplay">
                                <p class="text-muted">
                                    <i class="fas fa-chart-area fa-3x mb-3"></i><br>
                                    Configure features and click "Create Diagram"
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- MULTI-TRACK TAB -->
            <!-- ============================================================ -->
            <div class="tab-pane fade" id="multitrack">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-body p-3">
                                <form id="multiTrackForm">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4">
                                            <label for="multiTrackGenomeLength" class="form-label small mb-1">Genome Length (bp)</label>
                                            <input type="number" class="form-control form-control-sm"
                                                   id="multiTrackGenomeLength" value="30000" min="1000">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="multiTrackTitle" class="form-label small mb-1">Diagram Title</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   id="multiTrackTitle" value="Multi-Track Genome">
                                        </div>
                                        <div class="col-md-2">
                                            <label for="multiTrackDiagramType" class="form-label small mb-1">Type</label>
                                            <select class="form-select form-select-sm" id="multiTrackDiagramType">
                                                <option value="linear">Linear</option>
                                                <option value="circular">Circular</option>
                                            </select>
                                        </div>
                                        <div class="col-md-2">
                                            <label for="multiTrackPageSize" class="form-label small mb-1">Page Size</label>
                                            <select class="form-select form-select-sm" id="multiTrackPageSize">
                                                <option value="A4">A4</option>
                                                <option value="letter" selected>Letter</option>
                                                <option value="A3">A3</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small mb-1">File Upload (auto-creates tracks by feature type)</label>
                                        <input type="file" class="form-control form-control-sm" id="multiTrackFile"
                                               accept=".gb,.gbk,.genbank,.embl"
                                               onchange="handleMultiTrackFileUpload(event)">
                                        <div id="multitrackFileInfo" class="mt-1" style="display:none;"></div>
                                    </div>

                                    <hr class="my-3">

                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label small mb-0"><strong>Tracks</strong></label>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    onclick="addTrack()">
                                                <i class="fas fa-plus"></i> Add Track
                                            </button>
                                        </div>
                                        <div id="tracksContainer">
                                            <!-- Tracks added dynamically -->
                                        </div>
                                    </div>

                                    <button type="submit" class="gradient-btn-primary w-100 mb-2 mt-2" id="createMultiTrackBtn">
                                        <i class="fas fa-layer-group"></i> Create Multi-Track Diagram
                                    </button>
                                    <button type="button" class="gradient-btn-secondary w-100 mb-2"
                                            onclick="loadMultiTrackExample()">
                                        <i class="fas fa-flask"></i> Load Example
                                    </button>
                                    <button type="button" class="gradient-btn-small w-100"
                                            onclick="clearTracks()">
                                        <i class="fas fa-trash"></i> Clear Tracks
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small"><i class="fas fa-image"></i> Multi-Track Diagram</h6>
                            </div>
                            <div class="card-body p-3 text-center" id="multiTrackDisplay">
                                <p class="text-muted">
                                    <i class="fas fa-layer-group fa-3x mb-3"></i><br>
                                    Add tracks and features, then create diagram
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- DATA TRACKS TAB -->
            <!-- ============================================================ -->
            <div class="tab-pane fade" id="datatracks">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-body p-3">
                                <form id="dataTracksForm">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4">
                                            <label for="dataGenomeLength" class="form-label small mb-1">Genome Length (bp)</label>
                                            <input type="number" class="form-control form-control-sm"
                                                   id="dataGenomeLength" value="20000" min="1000">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="dataTitle" class="form-label small mb-1">Diagram Title</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   id="dataTitle" value="Genome Data Visualization">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="dataDiagramType" class="form-label small mb-1">Type</label>
                                            <select class="form-select form-select-sm" id="dataDiagramType">
                                                <option value="linear">Linear</option>
                                                <option value="circular">Circular</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label for="dataSequence" class="form-label small mb-1">DNA Sequence (for GC calculations)</label>
                                        <textarea class="form-control form-control-sm" id="dataSequence"
                                                  rows="3" placeholder="ATGCATGC...">ATGCATGCATGCATGCGCGCGCGCATATATATATGCGCGCGC</textarea>
                                        <div class="form-text small">
                                            <i class="fas fa-info-circle"></i> Required for GC content and GC skew graphs
                                        </div>
                                    </div>

                                    <hr class="my-3">

                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label small mb-0"><strong>Data Graphs</strong></label>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    onclick="addDataGraph()">
                                                <i class="fas fa-plus"></i> Add Graph
                                            </button>
                                        </div>
                                        <div id="dataGraphsContainer">
                                            <!-- Data graphs added dynamically -->
                                        </div>
                                    </div>

                                    <button type="submit" class="gradient-btn-primary w-100 mb-2 mt-2" id="createDataTracksBtn">
                                        <i class="fas fa-chart-line"></i> Create Data Tracks
                                    </button>
                                    <button type="button" class="gradient-btn-secondary w-100 mb-2"
                                            onclick="loadDataTrackExample()">
                                        <i class="fas fa-flask"></i> Load Example
                                    </button>
                                    <button type="button" class="gradient-btn-small w-100"
                                            onclick="clearDataGraphs()">
                                        <i class="fas fa-trash"></i> Clear Graphs
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small"><i class="fas fa-image"></i> Data Tracks Diagram</h6>
                            </div>
                            <div class="card-body p-3 text-center" id="dataTracksDisplay">
                                <p class="text-muted">
                                    <i class="fas fa-chart-line fa-3x mb-3"></i><br>
                                    Add data graphs and create visualization
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- ADVANCED FEATURES TAB -->
            <!-- ============================================================ -->
            <div class="tab-pane fade" id="advanced">
                <div class="row g-3">
                    <div class="col-12">
                        <div class="card mb-3">
                            <div class="card-body p-3">
                                <form id="advancedFeaturesForm">
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-4">
                                            <label for="advancedGenomeLength" class="form-label small mb-1">Genome Length (bp)</label>
                                            <input type="number" class="form-control form-control-sm"
                                                   id="advancedGenomeLength" value="15000" min="1000">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="advancedTitle" class="form-label small mb-1">Diagram Title</label>
                                            <input type="text" class="form-control form-control-sm"
                                                   id="advancedTitle" value="Advanced Feature Styling">
                                        </div>
                                        <div class="col-md-4">
                                            <label for="advancedDiagramType" class="form-label small mb-1">Type</label>
                                            <select class="form-select form-select-sm" id="advancedDiagramType">
                                                <option value="linear">Linear</option>
                                                <option value="circular">Circular</option>
                                            </select>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label small mb-1">File Upload</label>
                                        <input type="file" class="form-control form-control-sm" id="advancedFile"
                                               accept=".gb,.gbk,.genbank,.embl"
                                               onchange="handleAdvancedFileUpload(event)">
                                        <div id="advancedFileInfo" class="mt-1" style="display:none;"></div>
                                    </div>

                                    <hr class="my-3">

                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label small mb-0"><strong>Features (with sigils, strands, labels)</strong></label>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    onclick="addAdvancedFeature()">
                                                <i class="fas fa-plus"></i> Add Feature
                                            </button>
                                        </div>
                                        <div id="advancedFeaturesContainer">
                                            <!-- Advanced features added dynamically -->
                                        </div>
                                    </div>

                                    <hr class="my-3">

                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <label class="form-label small mb-0"><strong>CrossLinks (connect features across tracks)</strong></label>
                                            <button type="button" class="btn btn-sm btn-outline-primary"
                                                    onclick="addCrossLink()">
                                                <i class="fas fa-plus"></i> Add CrossLink
                                            </button>
                                        </div>
                                        <div id="crossLinksContainer">
                                            <!-- CrossLinks added dynamically -->
                                        </div>
                                    </div>

                                    <button type="submit" class="gradient-btn-primary w-100 mb-2 mt-2" id="createAdvancedBtn">
                                        <i class="fas fa-magic"></i> Create Advanced Diagram
                                    </button>
                                    <button type="button" class="gradient-btn-secondary w-100 mb-2"
                                            onclick="loadAdvancedExample()">
                                        <i class="fas fa-flask"></i> Load Example
                                    </button>
                                    <button type="button" class="gradient-btn-small w-100"
                                            onclick="clearAdvancedFeatures(); clearCrossLinks()">
                                        <i class="fas fa-trash"></i> Clear All
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small"><i class="fas fa-image"></i> Advanced Diagram</h6>
                            </div>
                            <div class="card-body p-3 text-center" id="advancedDisplay">
                                <p class="text-muted">
                                    <i class="fas fa-magic fa-3x mb-3"></i><br>
                                    Configure advanced features and create diagram
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============================================================ -->
            <!-- EXPORT TAB -->
            <!-- ============================================================ -->
            <div class="tab-pane fade" id="export">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body p-3">
                                <h6 class="mb-3"><i class="fas fa-download"></i> Export Options</h6>

                                <p class="small mb-3">Export the current diagram in various formats:</p>

                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" onclick="exportDiagram('png')" id="exportBtn">
                                        <i class="fas fa-file-image"></i> Export as PNG
                                    </button>
                                    <button class="btn btn-outline-success" onclick="exportDiagram('svg')">
                                        <i class="fas fa-vector-square"></i> Export as SVG (Vector)
                                    </button>
                                    <button class="btn btn-outline-danger" onclick="exportDiagram('pdf')">
                                        <i class="fas fa-file-pdf"></i> Export as PDF
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="exportDiagram('eps')">
                                        <i class="fas fa-file-code"></i> Export as EPS (PostScript)
                                    </button>
                                </div>

                                <div class="alert alert-info mt-3 mb-0 small">
                                    <i class="fas fa-info-circle"></i> <strong>Note:</strong> Create a diagram in any tab first before exporting
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body p-3">
                                <h6 class="mb-3"><i class="fas fa-info-circle"></i> Format Information</h6>

                                <div class="mb-3">
                                    <strong class="small">PNG (Raster)</strong>
                                    <p class="small mb-0 text-muted">Best for web display, presentations, quick sharing</p>
                                </div>

                                <div class="mb-3">
                                    <strong class="small">SVG (Vector)</strong>
                                    <p class="small mb-0 text-muted">Scalable, editable in Illustrator/Inkscape, web-friendly</p>
                                </div>

                                <div class="mb-3">
                                    <strong class="small">PDF (Document)</strong>
                                    <p class="small mb-0 text-muted">Publication-quality, prints well, professional documents</p>
                                </div>

                                <div class="mb-0">
                                    <strong class="small">EPS (PostScript)</strong>
                                    <p class="small mb-0 text-muted">Professional publishing, LaTeX documents, high-end printing</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mt-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header py-2">
                                <h6 class="mb-0 small"><i class="fas fa-info-circle"></i> BioPython GenomeDiagram Features</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row">
                                    <div class="col-md-3">
                                        <h6 class="small"><strong>Diagram Types</strong></h6>
                                        <ul class="small">
                                            <li>Linear diagrams</li>
                                            <li>Circular genomes</li>
                                            <li>Multiple tracks</li>
                                            <li>Data graphs</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-3">
                                        <h6 class="small"><strong>Feature Styling</strong></h6>
                                        <ul class="small">
                                            <li>Arrow sigils (BOX, ARROW, OCTO, JAGGY)</li>
                                            <li>Strand orientation (+/-)</li>
                                            <li>Labels and positioning</li>
                                            <li>Custom colors</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-3">
                                        <h6 class="small"><strong>Data Visualization</strong></h6>
                                        <ul class="small">
                                            <li>GC content plots</li>
                                            <li>GC skew analysis</li>
                                            <li>Custom data tracks</li>
                                            <li>Line, bar, heat styles</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-3">
                                        <h6 class="small"><strong>Advanced</strong></h6>
                                        <ul class="small">
                                            <li>CrossLinks (synteny)</li>
                                            <li>File parsing (GenBank, EMBL)</li>
                                            <li>Multiple output formats</li>
                                            <li>Scale customization</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/genomediagram.js') }}"></script>
{% endblock %}
